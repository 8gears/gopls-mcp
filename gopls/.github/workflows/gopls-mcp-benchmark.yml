name: gopls-mcp Benchmarks

on:
  push:
    branches: [master, main]
    paths:
      - 'mcpbridge/**'
      - '.github/workflows/gopls-mcp-benchmark.yml'
  pull_request:
    branches: [master, main]
    paths:
      - 'mcpbridge/**'
      - '.github/workflows/gopls-mcp-benchmark.yml'
  workflow_dispatch:

jobs:
  benchmark:
    name: Run Benchmarks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'
          cache: true
          cache-dependency-path: '**/go.sum'

      - name: Download Go dependencies
        working-directory: ./mcpbridge
        run: go mod download

      - name: Run benchmarks
        working-directory: ./mcpbridge/test/benchmark
        run: |
          echo "ğŸš€ Running gopls-mcp benchmark suite..."
          go run benchmark_main.go -compare

      - name: Generate benchmark report
        working-directory: ./mcpbridge/test/benchmark
        run: |
          echo "ğŸ“Š Generating benchmark report..."
          go run reportgen/main.go benchmark_results.json > RESULTS.md

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: |
            gopls/mcpbridge/test/benchmark/benchmark_results.json
            gopls/mcpbridge/test/benchmark/RESULTS.md
          retention-days: 30

      - name: Generate benchmark summary
        run: |
          echo "## ğŸ“Š Benchmark Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Summary" >> $GITHUB_STEP_SUMMARY

          # Extract key metrics from JSON
          cd gopls-mcp/test/benchmark

          TOTAL=$(jq -r '.total_benchmarks' benchmark_results.json)
          SUCCESS=$(jq -r '.summary.successful' benchmark_results.json)
          FAILED=$(jq -r '.summary.failed' benchmark_results.json)
          SPEEDUP=$(jq -r '.summary.speedup_range' benchmark_results.json)

          echo "- **Total Benchmarks:** $TOTAL" >> $GITHUB_STEP_SUMMARY
          echo "- **Successful:** âœ… $SUCCESS" >> $GITHUB_STEP_SUMMARY
          echo "- **Failed:** âŒ $FAILED" >> $GITHUB_STEP_SUMMARY
          echo "- **Speedup Range:** $SPEEDUP" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ğŸ† Speedup Comparisons" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          jq -r '.results[] |
            select(.SpeedupFactor > 0) |
            "- **\(.Name):** \(.SpeedupFactor | floor)x faster (\(.ComparisonNote))" >> $GITHUB_STEP_SUMMARY
          ' benchmark_results.json

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“ Full results available in workflow artifacts" >> $GITHUB_STEP_SUMMARY

      - name: Comment PR with results (if PR)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const results = JSON.parse(
              fs.readFileSync('gopls/mcpbridge/test/benchmark/benchmark_results.json', 'utf8')
            );

            const summary = results.summary;
            const speedups = results.results
              .filter(r => r.SpeedupFactor > 0)
              .map(r => {
                const speedup = r.SpeedupFactor.toFixed(1);
                return `**${r.Name}**: ${speedup}x faster`;
              })
              .join('\n');

            const comment = `## ğŸ“Š Benchmark Results

            ### Summary
            - **Total Benchmarks:** ${summary.total_benchmarks}
            - **Successful:** âœ… ${summary.successful}
            - **Failed:** âŒ ${summary.failed}
            - **Speedup Range:** ${summary.speedup_range}

            ### ğŸ† Speedup Comparisons
            ${speedups}

            ğŸ“ Full results available in workflow artifacts.

            <details>
            <summary>View detailed results</summary>

            \`\`\`json
            ${JSON.stringify(results.results.filter(r => r.SpeedupFactor > 0).map(r => ({
              name: r.Name,
              speedup: r.SpeedupFactor + 'x',
              note: r.ComparisonNote
            })), null, 2)}
            \`\`\`
            </details>
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
